{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 24px;">
    <h1 style="font-size: var(--md-sys-typescale-display-small); margin-bottom: 16px;">
        Analyze Custom Case
    </h1>
    <p style="color: var(--md-sys-color-on-surface-variant); margin-bottom: 32px;">
        Enter your medical case details for comprehensive AI ensemble analysis
    </p>

    <!-- Case Input Section -->
    <div class="card" style="padding: 32px; margin-bottom: 24px;">
        <h2 style="font-size: var(--md-sys-typescale-headline-small); margin-bottom: 24px;">
            Case Information
        </h2>
        
        <!-- Case Title -->
        <div style="margin-bottom: 24px;">
            <label for="case-title" style="display: block; margin-bottom: 8px; font-weight: 500;">
                Case Title (Optional)
            </label>
            <input type="text" id="case-title" class="input-field" 
                   placeholder="e.g., 45-year-old with recurring fever"
                   style="width: 100%; padding: 12px; border: 1px solid var(--md-sys-color-outline); 
                          border-radius: 8px; font-size: 16px;">
        </div>

        <!-- Case Description -->
        <div style="margin-bottom: 24px;">
            <label for="case-text" style="display: block; margin-bottom: 8px; font-weight: 500;">
                Case Description <span style="color: var(--md-sys-color-error);">*</span>
            </label>
            <textarea id="case-text" class="input-field" rows="12"
                      placeholder="Enter patient history, symptoms, lab results, and any relevant medical information..."
                      style="width: 100%; padding: 12px; border: 1px solid var(--md-sys-color-outline); 
                             border-radius: 8px; font-size: 16px; font-family: inherit; resize: vertical;"></textarea>
            <div style="margin-top: 8px; font-size: 14px; color: var(--md-sys-color-on-surface-variant);">
                <span id="char-count">0</span> characters | Minimum 100 characters recommended
            </div>
        </div>


        <!-- Analysis Options -->
        <div style="margin-bottom: 24px;">
            <h3 style="font-size: var(--md-sys-typescale-title-medium); margin-bottom: 16px;">
                Analysis Options
            </h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                    <input type="checkbox" id="use-free-models" checked onchange="toggleFreeModelsWarning()">
                    <span>Use free models only (no API costs)</span>
                </label>
                
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                    <input type="checkbox" id="use-cache" checked>
                    <span>Use cached responses if available</span>
                </label>
                
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                    <input type="checkbox" id="include-minority" checked>
                    <span>Include minority opinions</span>
                </label>
                
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                    <input type="checkbox" id="bias-analysis" checked>
                    <span>Perform bias analysis</span>
                </label>
            </div>
            
            <!-- Free models warning -->
            <div id="free-models-warning" style="display: block; margin-top: 16px; padding: 12px; background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container); border-radius: 8px;">
                <div style="display: flex; align-items: start; gap: 8px;">
                    <span class="material-symbols-rounded" style="font-size: 20px; margin-top: 2px;">warning</span>
                    <div style="flex: 1;">
                        <strong>Limited Analysis Quality with Free Models</strong><br>
                        <span style="font-size: 14px;">
                            Free models provide suboptimal orchestration and analysis compared to premium models. 
                            For comprehensive medical analysis with accurate consensus building, bias detection, 
                            and clinical recommendations, consider using paid models.
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Selection (Initially Hidden) -->
        <div id="model-selection" style="margin-top: 24px; padding: 24px; background: var(--md-sys-color-surface-variant); border-radius: 12px; display: none;">
            <h3 style="font-size: var(--md-sys-typescale-title-medium); margin-bottom: 16px;">
                Select Models (Optional)
            </h3>
            <p style="font-size: 14px; color: var(--md-sys-color-on-surface-variant); margin-bottom: 16px;">
                Choose specific models or leave unchecked to use default selection
            </p>
            <div id="model-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 8px;">
                <!-- Models will be populated here -->
            </div>
            <div style="margin-top: 16px; display: flex; gap: 12px;">
                <button class="btn btn-text" onclick="selectAllModels()">Select All</button>
                <button class="btn btn-text" onclick="deselectAllModels()">Deselect All</button>
                <button class="btn btn-text" onclick="selectFreeModels()">Free Only</button>
            </div>
        </div>

        <!-- Submit Button -->
        <div style="display: flex; gap: 16px; justify-content: flex-end;">
            <button class="btn btn-outlined" onclick="clearForm()">
                <span class="material-symbols-rounded">clear</span>
                Clear
            </button>
            <button class="btn btn-filled" id="analyze-btn" onclick="startAnalysis()">
                <span class="material-symbols-rounded">analytics</span>
                Analyze Case
            </button>
        </div>
    </div>

    <!-- Progress Section (Initially Hidden) -->
    <div id="progress-section" class="card" style="padding: 32px; margin-bottom: 24px; display: none;">
        <h2 style="font-size: var(--md-sys-typescale-headline-small); margin-bottom: 24px;">
            Analysis Progress
        </h2>
        
        <!-- Overall Progress -->
        <div style="margin-bottom: 32px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Overall Progress</span>
                <span id="progress-percentage">0%</span>
            </div>
            <div style="height: 8px; background: var(--md-sys-color-surface-variant); border-radius: 4px; overflow: hidden;">
                <div id="progress-bar" style="height: 100%; background: var(--md-sys-color-primary); width: 0%; transition: width 0.3s;"></div>
            </div>
        </div>

        <!-- Model Status Grid -->
        <div id="model-status" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
            <!-- Model status cards will be added here dynamically -->
        </div>

        <!-- Messages -->
        <div id="progress-messages" style="margin-top: 24px; max-height: 200px; overflow-y: auto; 
                                           padding: 16px; background: var(--md-sys-color-surface-variant); 
                                           border-radius: 8px; font-family: monospace; font-size: 12px;">
            <!-- Progress messages will appear here -->
        </div>
    </div>

    <!-- Results Section (Initially Hidden) -->
    <div id="results-section" style="display: none;">
        <div class="card" style="padding: 32px; margin-bottom: 24px;">
            <h2 style="font-size: var(--md-sys-typescale-headline-small); margin-bottom: 24px;">
                Analysis Complete
            </h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px;">
                <div style="text-align: center;">
                    <div style="font-size: 32px; font-weight: bold; color: var(--md-sys-color-primary);" id="models-count">0</div>
                    <div style="font-size: 14px; color: var(--md-sys-color-on-surface-variant);">Models Responded</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 32px; font-weight: bold; color: var(--md-sys-color-secondary);" id="consensus-percentage">0%</div>
                    <div style="font-size: 14px; color: var(--md-sys-color-on-surface-variant);">Consensus Rate</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 32px; font-weight: bold; color: var(--md-sys-color-tertiary);" id="diagnoses-count">0</div>
                    <div style="font-size: 14px; color: var(--md-sys-color-on-surface-variant);">Unique Diagnoses</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 32px; font-weight: bold; color: var(--md-sys-color-error);" id="time-taken">0s</div>
                    <div style="font-size: 14px; color: var(--md-sys-color-on-surface-variant);">Analysis Time</div>
                </div>
            </div>

            <!-- Failed Models Section (if any) -->
            <div id="failed-models-section" style="display: none; margin-bottom: 24px; padding: 16px; background: var(--md-sys-color-error-container); border-radius: 12px;">
                <h3 style="font-size: var(--md-sys-typescale-title-medium); margin-bottom: 12px; color: var(--md-sys-color-on-error-container);">
                    Failed Models (<span id="failed-count">0</span>)
                </h3>
                <div id="failed-models-list" style="margin-bottom: 12px; font-size: 14px;">
                    <!-- Failed models will be listed here -->
                </div>
                <button class="btn btn-filled" onclick="retryFailedModels()" style="background: var(--md-sys-color-error); color: var(--md-sys-color-on-error);">
                    <span class="material-symbols-rounded">refresh</span>
                    Retry Failed Models
                </button>
            </div>

            <!-- Rating Section -->
            <div id="rating-section" style="margin-bottom: 24px; padding: 16px; background: var(--md-sys-color-secondary-container); border-radius: 12px;">
                <h3 style="font-size: var(--md-sys-typescale-title-medium); margin-bottom: 12px; color: var(--md-sys-color-on-secondary-container);">
                    Rate This Analysis
                </h3>
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                    <span>How accurate was the diagnosis?</span>
                    <div class="star-rating" onclick="handleStarRating(event)">
                        <span class="star" data-rating="1">★</span>
                        <span class="star" data-rating="2">★</span>
                        <span class="star" data-rating="3">★</span>
                        <span class="star" data-rating="4">★</span>
                        <span class="star" data-rating="5">★</span>
                    </div>
                    <span id="rating-text" style="font-size: 14px; color: var(--md-sys-color-on-secondary-container);">Click to rate</span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-text" onclick="submitFeedback(true)" style="color: var(--md-sys-color-primary);">
                        <span class="material-symbols-rounded">thumb_up</span>
                        Correct
                    </button>
                    <button class="btn btn-text" onclick="submitFeedback(false)" style="color: var(--md-sys-color-error);">
                        <span class="material-symbols-rounded">thumb_down</span>
                        Incorrect
                    </button>
                </div>
            </div>

            <div style="display: flex; gap: 16px;">
                <button class="btn btn-filled" onclick="viewReport()">
                    <span class="material-symbols-rounded">visibility</span>
                    View Report
                </button>
                <button class="btn btn-tonal" onclick="downloadPDF()">
                    <span class="material-symbols-rounded">download</span>
                    Download PDF
                </button>
                <button class="btn btn-text" onclick="createShareableLink()">
                    <span class="material-symbols-rounded">share</span>
                    Share Result
                </button>
                <button class="btn btn-outlined" onclick="analyzeAnother()">
                    <span class="material-symbols-rounded">add</span>
                    Analyze Another
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Character counter
document.getElementById('case-text').addEventListener('input', function() {
    document.getElementById('char-count').textContent = this.value.length;
});

function clearForm() {
    document.getElementById('case-title').value = '';
    document.getElementById('case-text').value = '';
    document.getElementById('char-count').textContent = '0';
}

function toggleFreeModelsWarning() {
    const useFreeModels = document.getElementById('use-free-models').checked;
    const warningDiv = document.getElementById('free-models-warning');
    warningDiv.style.display = useFreeModels ? 'block' : 'none';
}

// Analysis functions
let analysisStartTime;
let analysisData = {};
let currentAnalysisId = null;
let failedModels = [];

function startAnalysis() {
    const caseText = document.getElementById('case-text').value.trim();
    const caseTitle = document.getElementById('case-title').value || 'Custom Medical Case';
    
    if (caseText.length < 100) {
        alert('Please enter at least 100 characters of case description');
        return;
    }
    
    // Show progress section
    document.getElementById('progress-section').style.display = 'block';
    document.getElementById('results-section').style.display = 'none';
    
    // Initialize progress
    analysisStartTime = Date.now();
    updateProgress(0, 'Initializing analysis...');
    
    // Generate analysis ID
    const analysisId = 'custom_' + Date.now();
    currentAnalysisId = analysisId;
    
    // Connect to WebSocket for real-time updates
    connectToAnalysis(analysisId, caseTitle, caseText);
}

function updateProgress(percentage, message) {
    document.getElementById('progress-percentage').textContent = percentage + '%';
    document.getElementById('progress-bar').style.width = percentage + '%';
    
    if (message) {
        const messageDiv = document.getElementById('progress-messages');
        messageDiv.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
        messageDiv.scrollTop = messageDiv.scrollHeight;
    }
}

function connectToAnalysis(analysisId, caseTitle, caseText) {
    // Join analysis room for updates
    socket.emit('join_analysis', {analysis_id: analysisId});
    
    // Set up event listeners for this analysis
    socket.once('analysis_started', function(data) {
        updateProgress(5, 'Analysis started. Analysis ID: ' + (data.analysis_id || analysisId));
        if (data.websocket_channel) {
            // Join the specific channel
            socket.emit('join_analysis', {analysis_id: data.analysis_id});
        }
    });
    
    socket.on('model_progress', function(data) {
        if (!currentAnalysisId || data.analysis_id === currentAnalysisId) {
            const progress = Math.round(data.progress || 0);
            updateProgress(progress, `Model ${data.model}: ${data.status}`);
            
            // Track failed models
            if (data.status === 'failed') {
                failedModels.push({
                    name: data.model,
                    error: data.error || 'Unknown error'
                });
            }
            
            if (data.response) {
                updateProgress(null, `   → Diagnosis: ${data.response}`);
            }
        }
    });
    
    socket.on('analysis_complete', function(data) {
        if (!currentAnalysisId || data.analysis_id === currentAnalysisId) {
            showResults(data);
            // Leave the room
            socket.emit('leave_analysis', {analysis_id: currentAnalysisId});
            // Clean up listeners
            socket.off('model_progress');
            socket.off('analysis_complete');
            socket.off('analysis_error');
        }
    });
    
    socket.on('analysis_error', function(data) {
        if (!currentAnalysisId || data.analysis_id === currentAnalysisId) {
            updateProgress(data.progress || 0, `ERROR: ${data.message}`);
            document.getElementById('progress-bar').style.backgroundColor = 'var(--md-sys-color-error)';
            // Clean up listeners
            socket.off('model_progress');
            socket.off('analysis_complete');
            socket.off('analysis_error');
        }
    });
    
    // Emit analyze event
    socket.emit('analyze_case', {
        case_id: analysisId,
        case_title: caseTitle,
        case_text: caseText,
        use_free_models: document.getElementById('use-free-models').checked,  // Use the checkbox value
        selected_models: getSelectedModels(),  // Get selected models if any
        api_key: localStorage.getItem('openrouter_api_key')
    });
}

function showResults(data) {
    const timeTaken = Math.floor((Date.now() - analysisStartTime) / 1000);
    
    // Update results with actual data or defaults
    const results = data?.results || {};
    document.getElementById('models-count').textContent = results.models_responded || '31';
    document.getElementById('consensus-percentage').textContent = 
        results.primary_diagnosis?.agreement_percentage ? 
        Math.round(results.primary_diagnosis.agreement_percentage) + '%' : '0%';
    document.getElementById('diagnoses-count').textContent = 
        (results.alternatives_count || 0) + (results.minority_count || 0) + 1;
    document.getElementById('time-taken').textContent = timeTaken + 's';
    
    // Show failed models if any
    if (failedModels.length > 0) {
        document.getElementById('failed-models-section').style.display = 'block';
        document.getElementById('failed-count').textContent = failedModels.length;
        const failedList = document.getElementById('failed-models-list');
        failedList.innerHTML = failedModels.map(m => 
            `<div>• ${m.name}: ${m.error}</div>`
        ).join('');
    }
    
    // Update report links if available
    if (data?.report_url) {
        const viewBtn = document.querySelector('[onclick="viewReport()"]');
        if (viewBtn) {
            viewBtn.onclick = function() {
                window.location.href = data.report_url;
            };
        }
    }
    if (data?.pdf_url) {
        const pdfBtn = document.querySelector('[onclick="downloadPDF()"]');
        if (pdfBtn) {
            pdfBtn.onclick = function() {
                window.location.href = data.pdf_url;
            };
        }
    }
    
    // Show results section
    document.getElementById('results-section').style.display = 'block';
    updateProgress(100, 'Analysis complete!');
}

function viewReport() {
    // TODO: Navigate to report viewer
    alert('Report viewer coming soon!');
}

function downloadPDF() {
    // TODO: Trigger PDF download
    alert('PDF download coming soon!');
}

function analyzeAnother() {
    clearForm();
    document.getElementById('progress-section').style.display = 'none';
    document.getElementById('results-section').style.display = 'none';
    failedModels = [];
}

function retryFailedModels() {
    if (!currentAnalysisId || failedModels.length === 0) return;
    
    // Show progress section again
    document.getElementById('failed-models-section').style.display = 'none';
    document.getElementById('progress-section').style.display = 'block';
    updateProgress(0, 'Retrying failed models...');
    
    // Send retry request
    fetch(`/api/analyze/${currentAnalysisId}/retry`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            models: failedModels.map(m => m.name)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'retry_started') {
            updateProgress(10, `Retrying ${failedModels.length} failed models...`);
            failedModels = []; // Reset failed models
        } else {
            updateProgress(0, `Retry failed: ${data.error || 'Unknown error'}`);
        }
    })
    .catch(error => {
        updateProgress(0, `Retry error: ${error.message}`);
    });
}

// Model selection functions
const availableModels = [
    // Free Models
    {id: 'google/gemini-2.0-flash-exp:free', name: 'Gemini 2.0 Flash', free: true, origin: 'USA'},
    {id: 'google/gemini-1.5-flash:free', name: 'Gemini 1.5 Flash', free: true, origin: 'USA'},
    {id: 'meta-llama/llama-3.2-3b-instruct:free', name: 'Llama 3.2 3B', free: true, origin: 'USA'},
    {id: 'meta-llama/llama-3.1-8b-instruct:free', name: 'Llama 3.1 8B', free: true, origin: 'USA'},
    {id: 'microsoft/phi-3-mini-128k-instruct:free', name: 'Phi-3 Mini', free: true, origin: 'USA'},
    {id: 'mistralai/mistral-7b-instruct:free', name: 'Mistral 7B', free: true, origin: 'France'},
    {id: 'qwen/qwen-2-7b-instruct:free', name: 'Qwen 2 7B', free: true, origin: 'China'},
    {id: 'nousresearch/hermes-3-llama-3.1-8b:free', name: 'Hermes 3', free: true, origin: 'USA'},
    
    // Paid Models (if not using free-only mode)
    {id: 'openai/gpt-4o', name: 'GPT-4o', free: false, origin: 'USA'},
    {id: 'anthropic/claude-3-opus', name: 'Claude 3 Opus', free: false, origin: 'USA'},
    {id: 'google/gemini-pro-1.5', name: 'Gemini Pro 1.5', free: false, origin: 'USA'},
    {id: 'deepseek/deepseek-chat', name: 'DeepSeek V3', free: false, origin: 'China'},
    {id: 'mistralai/mistral-large', name: 'Mistral Large', free: false, origin: 'France'}
];

function populateModelSelection() {
    const container = document.getElementById('model-checkboxes');
    const useFreeOnly = document.getElementById('use-free-models').checked;
    
    container.innerHTML = '';
    availableModels.forEach(model => {
        if (useFreeOnly && !model.free) return;
        
        const label = document.createElement('label');
        label.style.cssText = 'display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 4px;';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = model.id;
        checkbox.dataset.modelName = model.name;
        checkbox.dataset.free = model.free;
        
        const text = document.createElement('span');
        text.style.fontSize = '14px';
        text.innerHTML = `${model.name} <small style="color: var(--md-sys-color-on-surface-variant);">(${model.origin}${model.free ? ', Free' : ''})</small>`;
        
        label.appendChild(checkbox);
        label.appendChild(text);
        container.appendChild(label);
    });
}

function selectAllModels() {
    document.querySelectorAll('#model-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
}

function deselectAllModels() {
    document.querySelectorAll('#model-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
}

function selectFreeModels() {
    document.querySelectorAll('#model-checkboxes input[type="checkbox"]').forEach(cb => {
        cb.checked = cb.dataset.free === 'true';
    });
}

function getSelectedModels() {
    const selected = [];
    document.querySelectorAll('#model-checkboxes input[type="checkbox"]:checked').forEach(cb => {
        selected.push(cb.value);
    });
    return selected.length > 0 ? selected : null;
}

// Toggle model selection visibility based on free models checkbox
document.getElementById('use-free-models').addEventListener('change', function() {
    if (!this.checked) {
        document.getElementById('model-selection').style.display = 'block';
        populateModelSelection();
    } else {
        document.getElementById('model-selection').style.display = 'none';
    }
});

// Rating and feedback functions
let selectedRating = 0;
let currentDiagnosis = '';

function handleStarRating(event) {
    if (event.target.classList.contains('star')) {
        const rating = parseInt(event.target.dataset.rating);
        selectedRating = rating;
        
        // Update star display
        document.querySelectorAll('.star').forEach((star, index) => {
            if (index < rating) {
                star.style.color = '#FFD700';
            } else {
                star.style.color = '#DDD';
            }
        });
        
        // Update rating text
        const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
        document.getElementById('rating-text').textContent = ratingTexts[rating];
    }
}

function submitFeedback(isCorrect) {
    if (!currentAnalysisId) return;
    
    // Get primary diagnosis name
    const diagnosisElement = document.querySelector('#results-section');
    const diagnosis = currentDiagnosis || 'Primary Diagnosis';
    
    // Submit rating via API
    fetch(`/api/analyze/${currentAnalysisId}/rate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            diagnosis: diagnosis,
            rating: selectedRating,
            is_correct: isCorrect,
            feedback: null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show thank you message
            const ratingSection = document.getElementById('rating-section');
            ratingSection.innerHTML = `
                <div style="text-align: center; padding: 16px; color: var(--md-sys-color-on-secondary-container);">
                    <span class="material-symbols-rounded" style="font-size: 32px; margin-bottom: 8px;">check_circle</span>
                    <div>Thank you for your feedback!</div>
                    <div style="font-size: 12px; opacity: 0.8;">Your rating helps improve the system</div>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error submitting feedback:', error);
    });
}

function createShareableLink() {
    if (!currentAnalysisId) return;
    
    fetch(`/api/analyze/${currentAnalysisId}/share`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            expiry_hours: 24
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.share_url) {
            // Copy to clipboard
            navigator.clipboard.writeText(data.share_url).then(() => {
                // Show confirmation
                const shareBtn = document.querySelector('[onclick="createShareableLink()"]');
                const originalText = shareBtn.innerHTML;
                shareBtn.innerHTML = '<span class="material-symbols-rounded">check</span> Copied!';
                shareBtn.style.background = 'var(--md-sys-color-primary)';
                shareBtn.style.color = 'var(--md-sys-color-on-primary)';
                
                setTimeout(() => {
                    shareBtn.innerHTML = originalText;
                    shareBtn.style.background = '';
                    shareBtn.style.color = '';
                }, 2000);
            });
        }
    })
    .catch(error => {
        console.error('Error creating shareable link:', error);
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check if free models is checked by default
    if (!document.getElementById('use-free-models').checked) {
        populateModelSelection();
    }
});
</script>

<style>
.star-rating {
    cursor: pointer;
    user-select: none;
}

.star {
    font-size: 24px;
    color: #DDD;
    transition: color 0.2s;
    margin: 0 2px;
}

.star:hover {
    color: #FFD700;
}

.star-rating:hover .star {
    color: #DDD;
}

.star-rating:hover .star:hover,
.star-rating:hover .star:hover ~ .star {
    color: #FFD700;
}

.star-rating:hover .star:hover ~ .star {
    color: #DDD;
}
</style>
{% endblock %}