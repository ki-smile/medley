{% extends "base.html" %}

{% block title %}Analyze Medical Case - MEDLEY{% endblock %}

{% block styles %}
<style>
    .content-container {
        padding: 24px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .card {
        background: var(--md-sys-color-surface);
        border: 1px solid var(--md-sys-color-outline-variant);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: var(--md-sys-elevation-level1);
    }
    
    .card-title {
        font-size: var(--md-sys-typescale-headline-medium);
        color: var(--md-sys-color-on-surface);
        margin-bottom: 16px;
    }
    
    .form-field {
        margin-bottom: 24px;
    }
    
    .form-field label {
        display: block;
        font-size: var(--md-sys-typescale-body-medium);
        color: var(--md-sys-color-on-surface-variant);
        margin-bottom: 8px;
    }
    
    .form-field textarea,
    .form-field input[type="text"],
    .form-field input[type="password"] {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--md-sys-color-outline);
        border-radius: 8px;
        background: var(--md-sys-color-surface);
        color: var(--md-sys-color-on-surface);
        font-size: var(--md-sys-typescale-body-large);
        font-family: inherit;
    }
    
    .form-field textarea:focus,
    .form-field input:focus {
        outline: none;
        border-color: var(--md-sys-color-primary);
        border-width: 2px;
        padding: 11px;
    }
    
    .button-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 16px;
    }
    
    .model-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 12px;
        max-height: 400px;
        overflow-y: auto;
        padding: 16px;
        background: var(--md-sys-color-surface-variant);
        border-radius: 12px;
        margin-bottom: 16px;
    }
    
    .model-item {
        display: flex;
        align-items: center;
        padding: 8px;
        background: var(--md-sys-color-surface);
        border-radius: 8px;
        cursor: pointer;
    }
    
    .model-item:hover {
        background: var(--md-sys-color-primary-container);
    }
    
    .model-item input[type="checkbox"] {
        margin-right: 8px;
    }
    
    .progress-container {
        display: none !important;
        background: var(--md-sys-color-primary-container);
        border-radius: 16px;
        padding: 24px;
        margin: 24px 0;
        position: relative;
        z-index: 1;
        width: 100%;
        box-sizing: border-box;
    }
    
    .progress-container.show {
        display: block !important;
    }
    
    .progress-bar {
        height: 8px;
        background: var(--md-sys-color-surface-variant);
        border-radius: 4px;
        overflow: hidden;
        margin: 16px 0;
    }
    
    .progress-fill {
        height: 100%;
        background: var(--md-sys-color-primary);
        transition: width 0.3s ease;
    }
    
    .results-container {
        display: none;
    }
    
    .primary-card {
        background: linear-gradient(135deg, var(--md-sys-color-primary-container) 0%, var(--md-sys-color-secondary-container) 100%);
        border: none;
    }
    
    .diagnosis-badge {
        display: inline-block;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: var(--md-sys-typescale-label-large);
        margin: 4px;
    }
    
    .diagnosis-primary {
        background: var(--md-sys-color-primary);
        color: var(--md-sys-color-on-primary);
    }
    
    .diagnosis-alternative {
        background: var(--md-sys-color-secondary-container);
        color: var(--md-sys-color-on-secondary-container);
    }
    
    .diagnosis-minority {
        background: var(--md-sys-color-tertiary-container);
        color: var(--md-sys-color-on-tertiary-container);
    }
</style>
{% endblock %}

{% block content %}
<div class="content-container">
    <!-- Page Header -->
    <div class="card">
        <h1 class="card-title">üî¨ Analyze Medical Case</h1>
        <p style="color: var(--md-sys-color-on-surface-variant);">
            Enter your medical case details below and let our ensemble of AI models provide comprehensive diagnostic insights.
        </p>
    </div>
    
    <!-- Analysis Form -->
    <div class="card">
        <h2 class="card-title">üìù Case Details</h2>
        
        <form id="analyzeForm" onsubmit="event.preventDefault(); startAnalysis(); return false;">
            <div class="form-field">
                <label for="caseText">Case Description</label>
                <textarea 
                    id="caseText" 
                    name="case_text" 
                    rows="10" 
                    placeholder="Enter detailed medical case information including patient demographics, symptoms, history, examination findings, and any relevant test results..."
                    required
                ></textarea>
            </div>
            
            <!-- Model Selection -->
            <div class="form-field">
                <h3 style="font-size: var(--md-sys-typescale-title-large); margin-bottom: 12px;">ü§ñ Model Selection</h3>
                
                <div class="button-group">
                    <button type="button" class="btn btn-tonal" onclick="selectFreeModels()">
                        Free Models Only
                    </button>
                    <button type="button" class="btn btn-outlined" onclick="selectAllModels()">
                        All Models
                    </button>
                    <button type="button" class="btn btn-outlined" onclick="deselectAllModels()">
                        Clear Selection
                    </button>
                </div>
                
                <!-- Free Models Toggle -->
                <div class="card primary-card" style="padding: 16px; margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="useFreeModels" checked onchange="handleFreeModelsToggle()" style="margin-right: 12px; width: 20px; height: 20px;">
                        <div>
                            <div style="font-weight: 600;">Limit to Free Models Only</div>
                            <div style="font-size: var(--md-sys-typescale-body-small); opacity: 0.8;">
                                Uncheck to enable premium models (17 free + 25 paid available)
                            </div>
                        </div>
                    </label>
                </div>
                
                <!-- Orchestrator Model Selector -->
                <div class="card" style="padding: 16px; margin-bottom: 16px;">
                    <label for="orchestratorModel" style="font-weight: 600; margin-bottom: 8px; display: block;">
                        üß† Orchestrator Model
                    </label>
                    <select id="orchestratorModel" name="orchestrator_model" style="width: 100%; padding: 12px; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; background: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); font-size: var(--md-sys-typescale-body-large);">
                        <option value="auto">Auto (Use Priority List - Recommended)</option>
                        <optgroup label="üèÜ Recommended Free Orchestrators">
                            <option value="qwen/qwen-2.5-coder-32b-instruct">Qwen 2.5 Coder 32B - BEST ($0.0075)</option>
                            <option value="openai/gpt-oss-20b:free">GPT-OSS 20B - Very Good ($0.0076)</option>
                            <option value="deepseek/deepseek-chat-v3.1:free">DeepSeek Chat v3.1 - Good (Free)</option>
                        </optgroup>
                        <optgroup label="üíé Premium Orchestrators">
                            <option value="anthropic/claude-3-5-sonnet-20241022">Claude 3.5 Sonnet - Highest Quality</option>
                            <option value="openai/gpt-4o">GPT-4o - OpenAI's Best</option>
                            <option value="google/gemini-2.5-pro">Gemini 2.5 Pro - Google's Latest</option>
                        </optgroup>
                        <optgroup label="üìä Other Options">
                            <option value="statistical">Statistical Only (No AI - $0.00)</option>
                        </optgroup>
                    </select>
                    <div style="font-size: var(--md-sys-typescale-body-small); opacity: 0.8; margin-top: 8px;">
                        The orchestrator model analyzes all AI responses and builds the final consensus report. Based on testing, Qwen provides the best cost-effectiveness at $0.0075 per analysis.
                    </div>
                </div>
                
                <!-- Model Grid -->
                <div id="modelSelection" class="model-grid" style="min-height: 200px;">
                    <div id="modelLoadingMessage" style="text-align: center; padding: 40px; color: var(--md-sys-color-on-surface-variant);">
                        <span class="material-symbols-rounded" style="font-size: 48px; opacity: 0.5;">pending</span>
                        <p>Loading available models...</p>
                        <p style="font-size: 12px; margin-top: 10px;">If models don't load, please refresh the page.</p>
                    </div>
                </div>
            </div>
            
            
            <!-- API Key (only show if not configured) -->
            {% if not (session.get('api_key') or session.get('openrouter_api_key')) %}
            <div class="form-field">
                <h3 style="font-size: var(--md-sys-typescale-title-large); margin-bottom: 12px;">üîë API Configuration</h3>
                
                <div class="card" style="background: var(--md-sys-color-surface-variant); padding: 16px;">
                    <p style="margin-bottom: 12px; color: var(--md-sys-color-error);">
                        ‚ö†Ô∏è No API key configured. Please enter your key below or <a href="/settings" style="color: var(--md-sys-color-primary);">configure in Settings</a>
                    </p>
                    <p style="margin-bottom: 12px;">
                        Get your key at <a href="https://openrouter.ai/keys" target="_blank" style="color: var(--md-sys-color-primary);">openrouter.ai/keys</a>
                    </p>
                    
                    <label for="apiKey">API Key</label>
                    <input 
                        type="password" 
                        id="apiKey" 
                        name="api_key" 
                        placeholder="sk-or-v1-..."
                        value=""
                        style="width: 100%; padding: 12px; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; margin-top: 8px;"
                        required
                    >
                    <div id="apiKeyStatus" style="margin-top: 8px;"></div>
                </div>
            </div>
            {% else %}
            <!-- Hidden input for configured API key -->
            <input 
                type="hidden" 
                id="apiKey" 
                name="api_key" 
                value="{{ session.get('api_key', session.get('openrouter_api_key', '')) }}"
            >
            {% endif %}
            
            <!-- Submit Button -->
            <div style="text-align: center;">
                <button type="button" onclick="startAnalysis()" class="btn btn-filled" style="padding: 14px 32px; font-size: var(--md-sys-typescale-label-large);">
                    üöÄ Start Analysis
                </button>
                <button type="button" class="btn btn-outlined" onclick="loadSampleCase()" style="margin-left: 12px;">
                    üìã Load Sample Case
                </button>
            </div>
        </form>
    </div>
    
    <!-- Progress Container -->
    <div id="progressContainer" class="progress-container">
        <h3 style="margin-bottom: 16px; color: var(--md-sys-color-on-primary-container);">
            üîÑ Analysis in Progress
        </h3>
        
        <!-- Stage Indicators -->
        <div style="display: flex; justify-content: space-between; margin-bottom: 16px; gap: 8px;">
            <div id="stage1" style="flex: 1; text-align: center; padding: 8px; background: var(--md-sys-color-surface-variant); border-radius: 8px; transition: all 0.3s;">
                <div style="font-weight: 600;">Stage 1</div>
                <div style="font-size: 0.85em;">Model Responses</div>
            </div>
            <div id="stage2" style="flex: 1; text-align: center; padding: 8px; background: var(--md-sys-color-surface-variant); border-radius: 8px; opacity: 0.5; transition: all 0.3s;">
                <div style="font-weight: 600;">Stage 2</div>
                <div style="font-size: 0.85em;">Orchestration</div>
            </div>
            <div id="stage3" style="flex: 1; text-align: center; padding: 8px; background: var(--md-sys-color-surface-variant); border-radius: 8px; opacity: 0.5; transition: all 0.3s;">
                <div style="font-weight: 600;">Stage 3</div>
                <div style="font-size: 0.85em;">Report Generation</div>
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span id="progressText">Initializing analysis...</span>
            <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        <div id="currentModel" style="font-size: var(--md-sys-typescale-body-medium); margin-top: 12px;">
            Preparing models...
        </div>
        
        <!-- Cost Tracking Section -->
        <div id="costTracker" style="margin-top: 16px; padding: 12px; background: var(--md-sys-color-surface-variant); border-radius: 8px; opacity: 0.9;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; font-size: var(--md-sys-typescale-body-medium);">
                    üí∞ Analysis Cost
                </span>
                <span id="costDisplay" style="font-weight: 600; font-size: var(--md-sys-typescale-body-large); color: var(--md-sys-color-primary);">
                    $0.00
                </span>
            </div>
            <div id="costStatus" style="font-size: var(--md-sys-typescale-body-small); opacity: 0.8;">
                Using free models - no cost incurred
            </div>
        </div>
        
        <!-- Cancel Button -->
        <div style="text-align: center; margin-top: 16px;">
            <button id="cancelButton" type="button" onclick="cancelAnalysis()" class="btn btn-outlined" style="color: var(--md-sys-color-error); border-color: var(--md-sys-color-error);">
                ‚ùå Cancel Analysis
            </button>
        </div>
        
        <!-- Error Messages -->
        <div id="errorContainer" style="display: none; margin-top: 16px; padding: 12px; background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container); border-radius: 8px;">
            <strong>‚ö†Ô∏è Error:</strong> <span id="errorMessage"></span>
        </div>
        
        <!-- Model Status Grid -->
        <div id="modelStatusGrid" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
            <!-- Model statuses will be added here -->
        </div>
    </div>
    
    <!-- Results Section -->
    <div id="resultsSection" class="results-container">
        <div class="card" style="text-align: center;">
            <h2 class="card-title" style="margin-bottom: 24px;">üéâ Analysis Complete!</h2>
            
            <p style="margin-bottom: 32px; color: var(--md-sys-color-on-surface-variant);">
                Your comprehensive medical case analysis is ready. View the full report with detailed diagnosis consensus, model insights, and bias analysis.
            </p>
            
            <!-- Report Links -->
            <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-filled" onclick="viewFullReport()">
                    üìÑ View Full Report (HTML)
                </button>
                <button class="btn btn-tonal" onclick="downloadPDFReport()">
                    üì• Download PDF Report
                </button>
            </div>
            
            <div style="margin-top: 24px;">
                <button class="btn btn-outlined" onclick="startNewAnalysis()">
                    üîÑ New Analysis
                </button>
            </div>
        </div>
    </div>
    
    <!-- Recent Analyses -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 class="card-title" style="margin: 0;">üìö Recent Analyses</h3>
            <button onclick="clearAnalysisHistory()" class="btn btn-text" style="font-size: 12px; padding: 6px 12px;">
                üóëÔ∏è Clear History
            </button>
        </div>
        <div id="recentAnalyses">
            <p style="color: var(--md-sys-color-on-surface-variant);">
                No recent analyses found. Start your first analysis above!
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let currentAnalysisId = null;
let analysisInProgress = false;
let lastProcessingModel = null;  // Track the current model being processed
let progressSessionId = null;    // Progress session ID for long polling
let longPollingActive = false;   // Flag to control long polling

// Models will be populated on page load

// Initialize models - will be loaded dynamically from backend
window.models = {
    free: [],
    paid: []
};

let modelsLoaded = false;
let domReady = false;

// Load models from backend
async function loadModels() {
    if (modelsLoaded) return;
    
    try {
        console.log('üîÑ Loading models from API...');
        const response = await fetch('/api/available_models');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        window.models = data;
        modelsLoaded = true;
        console.log(`‚úÖ Loaded ${data.free.length} free models and ${data.paid.length} paid models from backend`);
        
        // Trigger population if DOM is ready
        if (domReady) {
            initializeModels();
        }
    } catch (error) {
        console.error('‚ùå Failed to load models from backend:', error);
        // Fallback to default minimal set
        window.models = {
            free: [
                { id: 'google/gemma-2-9b-it:free', name: 'Gemma 2 9B', provider: 'Google' },
                { id: 'meta-llama/llama-3.2-3b-instruct:free', name: 'Llama 3.2 3B', provider: 'Meta' },
                { id: 'mistralai/mistral-7b-instruct:free', name: 'Mistral 7B', provider: 'Mistral' }
            ],
            paid: [
                { id: 'openai/gpt-4o', name: 'GPT-4o', provider: 'OpenAI' },
                { id: 'anthropic/claude-3-opus-20240229', name: 'Claude 3 Opus', provider: 'Anthropic' }
            ]
        };
        modelsLoaded = true;
        if (domReady) {
            initializeModels();
        }
    }
}

function initializeModels() {
    if (!modelsLoaded || !domReady) return;
    
    console.log('üöÄ Initializing analyze page with models and DOM ready');
    
    const progressContainer = document.getElementById('progressContainer');
    console.log('üîç Progress container exists:', !!progressContainer);
    
    // Check if model selection container exists
    const modelContainer = document.getElementById('modelSelection');
    console.log('ü§ñ Model selection container exists:', !!modelContainer);
    
    // Populate models
    console.log('üì¶ Populating models - Free:', window.models.free.length, 'Paid:', window.models.paid.length);
    populateModelSelection();
    
    // Load recent analyses
    loadRecentAnalyses();
    
    // Setup event listeners
    setupEventListeners();
    
    // Initialize model selection based on checkbox state
    const useFreeModels = document.getElementById('useFreeModels');
    if (useFreeModels && useFreeModels.checked) {
        console.log('‚úÖ Free models only is checked, selecting free models');
        selectFreeModels();
        // Disable paid models initially if free-only is checked
        document.querySelectorAll('.paid-model').forEach(el => {
            el.closest('.model-item').style.opacity = '0.5';
            el.closest('.model-item').style.pointerEvents = 'none';
        });
    }
    
    // Verify models were populated
    const modelItems = document.querySelectorAll('.model-item');
    console.log('üî¢ Total model items created:', modelItems.length);
}

// Start loading models immediately
loadModels();

// Handle DOM ready state
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        domReady = true;
        initializeModels();
    });
} else {
    // DOM is already ready
    domReady = true;
    initializeModels();
}

// Also add a failsafe to populate after 1 second
setTimeout(function() {
    const container = document.getElementById('modelSelection');
    if (container && container.querySelector('#modelLoadingMessage')) {
        console.log('üîß Failsafe: Force populating models...');
        populateModelSelection();
    }
}, 1000);

// Removed duplicate initialization - now handled by initializeModels() function

// Populate model selection grid
function populateModelSelection() {
    const container = document.getElementById('modelSelection');
    if (!container) {
        console.error('‚ùå Model selection container not found!');
        return;
    }
    
    // Check if models exist
    if (!window.models || !window.models.free || !window.models.paid) {
        console.error('‚ùå Models data not found!');
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--md-sys-color-error);">Error loading models. Please refresh the page.</div>';
        return;
    }
    
    let html = '';
    
    // Free models
    html += '<div style="grid-column: 1 / -1; font-weight: 600; color: var(--md-sys-color-primary);">Free Models:</div>';
    window.models.free.forEach(model => {
        html += `
            <div class="model-item">
                <input type="checkbox" name="models" value="${model.id}" class="model-check free-model" checked>
                <div>
                    <div>${model.name}</div>
                    <div style="font-size: var(--md-sys-typescale-body-small); opacity: 0.7;">${model.provider}</div>
                </div>
            </div>
        `;
    });
    
    // Paid models
    html += '<div style="grid-column: 1 / -1; font-weight: 600; margin-top: 16px;">Premium Models:</div>';
    window.models.paid.forEach(model => {
        html += `
            <div class="model-item">
                <input type="checkbox" name="models" value="${model.id}" class="model-check paid-model">
                <div>
                    <div>${model.name}</div>
                    <div style="font-size: var(--md-sys-typescale-body-small); opacity: 0.7;">${model.provider} üí∞</div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    console.log('‚úÖ Models populated successfully');
}

// Model selection functions
function handleFreeModelsToggle() {
    const useFreeOnly = document.getElementById('useFreeModels').checked;
    if (useFreeOnly) {
        // Select all free models, deselect paid models
        document.querySelectorAll('.free-model').forEach(cb => cb.checked = true);
        document.querySelectorAll('.paid-model').forEach(cb => cb.checked = false);
    } else {
        // Enable paid models (but don't auto-select them)
        // User can manually select which paid models they want
    }
}

function selectFreeModels() {
    document.querySelectorAll('.free-model').forEach(cb => cb.checked = true);
    document.querySelectorAll('.paid-model').forEach(cb => cb.checked = false);
}

function selectAllModels() {
    document.querySelectorAll('.model-check').forEach(cb => cb.checked = true);
}

function deselectAllModels() {
    document.querySelectorAll('.model-check').forEach(cb => cb.checked = false);
}

// Setup event listeners
function setupEventListeners() {
    // Form submission
    document.getElementById('analyzeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!analysisInProgress) {
            startAnalysis();
        }
    });
    
    // Free models toggle
    document.getElementById('useFreeModels').addEventListener('change', function() {
        const modelSelection = document.getElementById('modelSelection');
        if (this.checked) {
            // When checked, select only free models but keep grid visible
            selectFreeModels();
            // Optionally hide paid models or keep all visible
            document.querySelectorAll('.paid-model').forEach(el => {
                el.closest('.model-item').style.opacity = '0.5';
                el.closest('.model-item').style.pointerEvents = 'none';
            });
        } else {
            // When unchecked, show all models
            document.querySelectorAll('.paid-model').forEach(el => {
                el.closest('.model-item').style.opacity = '1';
                el.closest('.model-item').style.pointerEvents = 'auto';
            });
        }
    });
    
    // Tab switching
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const tab = this.dataset.tab;
            
            // Update active button
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(tab + 'Tab').style.display = 'block';
        });
    });
}

// Long polling implementation to replace WebSocket
async function startLongPolling() {
    if (!progressSessionId || !longPollingActive) {
        console.log('‚ö†Ô∏è Progress session not available or long polling not active');
        return;
    }
    
    console.log('üîÑ Starting long polling for session:', progressSessionId);
    
    let lastEventId = null;
    
    while (longPollingActive && progressSessionId) {
        try {
            const timeout = 30000; // 30 seconds timeout
            const url = `/api/progress/${progressSessionId}/events?timeout=${timeout / 1000}${lastEventId ? `&since_id=${lastEventId}` : ''}`;
            
            console.log('üì° Long polling request:', url);
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üì® Long polling response:', data);
            
            if (data.success && data.events && data.events.length > 0) {
                // Process each event
                for (const event of data.events) {
                    console.log('üéØ Processing event:', event);
                    lastEventId = event.id;
                    processProgressEvent(event);
                }
            }
            
            // Small delay before next request to prevent tight loops
            await new Promise(resolve => setTimeout(resolve, 100));
            
        } catch (error) {
            console.error('‚ùå Long polling error:', error);
            
            // If we get a network error, wait longer before retrying
            if (longPollingActive) {
                console.log('‚è≥ Waiting 2 seconds before retry...');
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }
    }
    
    console.log('üîª Long polling stopped');
}

function processProgressEvent(event) {
    console.log('üîÑ Processing event:', event.type, event.data);
    
    switch (event.type) {
        case 'analysis_started':
            console.log('‚úÖ Analysis started event received:', event.data);
            currentAnalysisId = event.data.analysis_id || progressSessionId;
            showProgress();
            if (event.data.models) {
                initializeModelStatus(event.data.models);
            }
            break;
            
        case 'model_started':
            console.log('üöÄ Model started:', event.data);
            if (event.data.message) {
                document.getElementById('progressText').textContent = event.data.message;
                document.getElementById('currentModel').innerHTML = `<strong>Current Model:</strong> ${event.data.model_name}`;
            }
            updateModelStatus(event.data.model_name, 'processing');
            break;
            
        case 'model_completed':
            console.log('‚úÖ Model completed:', event.data);
            if (event.data.message) {
                document.getElementById('progressText').textContent = event.data.message;
            }
            updateModelStatus(event.data.model_name, event.data.status === 'completed' ? 'completed' : 'failed');
            break;
            
        case 'progress_update':
            console.log('üìä Progress update:', event.data);
            if (event.data.progress_percent !== undefined) {
                updateProgress(event.data.progress_percent, event.data.message);
            }
            if (event.data.message) {
                document.getElementById('progressText').textContent = event.data.message;
            }
            break;
            
        case 'analysis_completed':
            console.log('üéâ Analysis completed:', event.data);
            handleAnalysisComplete(event.data);
            break;
            
        case 'analysis_error':
            console.log('‚ùå Analysis error:', event.data);
            showError(event.data.error || 'Analysis failed');
            longPollingActive = false;
            break;
            
        case 'cost_update':
            console.log('üí∞ Cost update:', event.data);
            if (event.data.current_cost !== undefined) {
                updateCostDisplay(event.data.current_cost, event.data.use_free_models, event.data.model_name, event.data.model_cost);
            }
            break;
            
        default:
            console.log('‚ùì Unknown event type:', event.type, event.data);
            break;
    }
}

function handleAnalysisComplete(data) {
    // Update progress to show completion
    document.getElementById('progressBar').style.width = '100%';
    document.getElementById('progressPercent').textContent = '100%';
    document.getElementById('progressText').textContent = 'Analysis Complete';
    document.getElementById('currentModel').innerHTML = '<strong>‚úÖ All models processed</strong>';
    
    // Hide the cancel button since analysis is complete
    const cancelBtn = document.getElementById('cancelButton');
    if (cancelBtn) {
        cancelBtn.style.display = 'none';
    }
    
    // Mark all model status cards as completed
    const modelDivs = document.querySelectorAll('[id^="model-"]');
    modelDivs.forEach((modelDiv) => {
        const statusIcon = modelDiv.querySelector('.status-icon');
        if (statusIcon && statusIcon.textContent !== '‚ùå') {
            modelDiv.style.background = 'var(--md-sys-color-primary-container)';
            statusIcon.textContent = '‚úÖ';
        }
    });
    
    // Store report URLs if available
    if (data.report_url || data.pdf_url) {
        currentReportUrl = data.report_url;
        currentPdfUrl = data.pdf_url;
        
        // Show the results section
        document.getElementById('resultsSection').style.display = 'block';
        
        // Save to history
        const caseText = document.getElementById('caseText').value;
        const analysisData = {
            report_url: data.report_url,
            pdf_url: data.pdf_url,
            successful_models: data.successful_models,
            total_models: data.total_models
        };
        saveAnalysisToHistory(currentAnalysisId, caseText, analysisData);
    }
    
    // Update stage indicators to completed
    updateStageIndicator(4);
    
    // Add analysis summary
    addAnalysisSummary();
    
    // Stop long polling
    longPollingActive = false;
    analysisInProgress = false;
}

// Start analysis
async function startAnalysis() {
    const caseText = document.getElementById('caseText').value.trim();
    // Get API key from input field if it exists, otherwise it's in session
    const apiKeyElement = document.getElementById('apiKey');
    const apiKey = apiKeyElement ? apiKeyElement.value.trim() : '';
    const hasSessionKey = {{ 'true' if session.get('api_key') else 'false' }};
    
    if (!caseText) {
        alert('Please enter case text');
        return;
    }
    
    // Check if we have an API key either from input or session
    if (!apiKey && !hasSessionKey) {
        alert('Please enter an API key or configure it in Settings');
        return;
    }
    
    try {
        analysisInProgress = true;
        console.log('üöÄ Starting analysis with long polling');
        showProgress();
        
        // Create progress session first
        console.log('üìã Creating progress session...');
        const progressResponse = await fetch('/api/progress/session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!progressResponse.ok) {
            throw new Error(`Failed to create progress session: ${progressResponse.status}`);
        }
        
        const progressData = await progressResponse.json();
        if (!progressData.success) {
            throw new Error('Failed to create progress session');
        }
        
        progressSessionId = progressData.session_id;
        console.log('‚úÖ Progress session created:', progressSessionId);
        
        // Start long polling
        longPollingActive = true;
        startLongPolling(); // Don't await - let it run in parallel
        
        // Get model selection preferences
        const useFreeModels = document.getElementById('useFreeModels').checked;
        const orchestratorModel = document.getElementById('orchestratorModel').value;
        
        // Get selected models from checkboxes
        let selectedModels = [];
        const checkedBoxes = document.querySelectorAll('.model-check:checked');
        checkedBoxes.forEach(checkbox => {
            selectedModels.push(checkbox.value);
        });
        
        // If no models selected, show error
        if (selectedModels.length === 0) {
            alert('Please select at least one model');
            analysisInProgress = false;
            longPollingActive = false;
            return;
        }
        
        console.log(`Selected ${selectedModels.length} models from checkboxes`);
        
        // Initialize model status display
        const modelNames = selectedModels.map(id => {
            const model = [...window.models.free, ...window.models.paid].find(m => m.id === id);
            return model ? model.name : id;
        });
        initializeModelStatus(modelNames);
        
        // Start the analysis
        currentAnalysisId = 'case_' + Date.now();
        console.log('üöÄ Starting analysis via API...');
        
        const analysisResponse = await fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                case_text: caseText,
                case_title: 'Custom Case',
                api_key: apiKey,
                use_free_models: useFreeModels,
                selected_models: selectedModels,
                orchestrator_model: orchestratorModel,
                progress_session_id: progressSessionId
            })
        });
        
        const analysisData = await analysisResponse.json();
        
        if (!analysisResponse.ok) {
            throw new Error(analysisData.error || 'Analysis failed to start');
        }
        
        console.log('‚úÖ Analysis started successfully:', analysisData);
        
        // Store the analysis ID from response if available
        if (analysisData.analysis_id) {
            currentAnalysisId = analysisData.analysis_id;
        }
        
        // The long polling will handle all progress updates from here
        
    } catch (error) {
        console.error('‚ùå Error starting analysis:', error);
        hideProgress();
        showError('Error: ' + error.message);
        analysisInProgress = false;
        longPollingActive = false;
        progressSessionId = null;
    }
}

// Progress functions
function showProgress() {
    console.log('üîÑ showProgress() called');
    const progressContainer = document.getElementById('progressContainer');
    console.log('üì¶ progressContainer element:', progressContainer);
    
    if (progressContainer) {
        // Use CSS class to show progress container
        progressContainer.classList.add('show');
        console.log('‚úÖ Added "show" class to progressContainer');
        console.log('Container classes:', progressContainer.className);
        
        // Initialize stage indicator to Stage 1
        updateStageIndicator(1);
    } else {
        console.error('‚ùå progressContainer element not found!');
    }
    
    // Reset progress bar
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressPercent').textContent = '0%';
    document.getElementById('progressText').textContent = 'Initializing analysis...';
    
    // Reset cost display
    document.getElementById('costDisplay').textContent = '$0.00';
    document.getElementById('costStatus').textContent = 'Calculating costs...';
    
    // Show cancel button when starting new analysis
    const cancelBtn = document.getElementById('cancelButton');
    if (cancelBtn) {
        cancelBtn.style.display = 'inline-block';
    }
    
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('errorContainer').style.display = 'none';
    
    analysisInProgress = true;
}

function hideProgress() {
    console.log('üîª hideProgress() called');
    console.trace('Hide progress call stack');
    const progressContainer = document.getElementById('progressContainer');
    if (progressContainer) {
        progressContainer.classList.remove('show');
    }
    analysisInProgress = false;
}

function updateCostDisplay(currentCost, useFreeModels, modelName, modelCost) {
    console.log('üí∞ Updating cost display:', { currentCost, useFreeModels, modelName, modelCost });
    
    const costDisplay = document.getElementById('costDisplay');
    const costStatus = document.getElementById('costStatus');
    
    if (costDisplay) {
        if (useFreeModels || currentCost === 0) {
            costDisplay.textContent = '$0.00';
            costDisplay.style.color = 'var(--md-sys-color-tertiary)';
        } else {
            costDisplay.textContent = '$' + currentCost.toFixed(2);
            costDisplay.style.color = 'var(--md-sys-color-primary)';
        }
    }
    
    if (costStatus) {
        if (useFreeModels) {
            costStatus.textContent = 'Using free models - no cost incurred';
            costStatus.style.color = 'var(--md-sys-color-tertiary)';
        } else if (modelName && modelCost > 0) {
            costStatus.textContent = `Latest: +$${modelCost.toFixed(2)} from ${modelName}`;
            costStatus.style.color = 'var(--md-sys-color-on-surface)';
        } else if (modelName) {
            costStatus.textContent = `Processing: ${modelName}`;
            costStatus.style.color = 'var(--md-sys-color-on-surface-variant)';
        } else {
            costStatus.textContent = `Total analysis cost: $${currentCost.toFixed(2)}`;
            costStatus.style.color = 'var(--md-sys-color-on-surface)';
        }
    }
}

function cancelAnalysis() {
    if (analysisInProgress && (currentAnalysisId || progressSessionId)) {
        console.log('üö´ Cancelling analysis:', currentAnalysisId);
        
        // Stop long polling
        longPollingActive = false;
        
        // Reset state
        analysisInProgress = false;
        currentAnalysisId = null;
        progressSessionId = null;
        
        // Hide progress and show form
        hideProgress();
        
        // Show cancellation message
        showError('Analysis cancelled by user');
        
        console.log('‚úÖ Analysis cancelled');
    }
}

function updateProgress(percent, status, model, stage) {
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
    document.getElementById('progressText').textContent = status || 'Processing...';
    if (model) {
        document.getElementById('currentModel').innerHTML = `<strong>Current Model:</strong> ${model}`;
    } else if (stage === 2) {
        document.getElementById('currentModel').innerHTML = '<strong>üß† Orchestrating consensus...</strong>';
    } else if (stage === 3) {
        document.getElementById('currentModel').innerHTML = '<strong>üìÑ Generating reports...</strong>';
    }
}

function updateStageIndicator(currentStage) {
    console.log(`Updating stage indicator to stage ${currentStage}`);
    
    // Reset all stages
    for (let i = 1; i <= 3; i++) {
        const stageEl = document.getElementById(`stage${i}`);
        if (stageEl) {
            if (i < currentStage) {
                // Completed stage
                stageEl.style.background = 'var(--md-sys-color-primary-container)';
                stageEl.style.opacity = '1';
                stageEl.style.color = 'var(--md-sys-color-on-primary-container)';
                stageEl.style.border = '2px solid var(--md-sys-color-primary)';
                stageEl.style.fontWeight = '500';
            } else if (i === currentStage) {
                // Current stage - highlight it
                stageEl.style.background = 'var(--md-sys-color-primary)';
                stageEl.style.opacity = '1';
                stageEl.style.color = 'var(--md-sys-color-on-primary)';
                stageEl.style.border = '2px solid var(--md-sys-color-primary)';
                stageEl.style.fontWeight = '600';
                stageEl.style.transform = 'scale(1.05)';
            } else {
                // Future stage
                stageEl.style.background = 'var(--md-sys-color-surface-variant)';
                stageEl.style.opacity = '0.5';
                stageEl.style.color = 'var(--md-sys-color-on-surface-variant)';
                stageEl.style.border = '2px solid transparent';
                stageEl.style.fontWeight = '400';
                stageEl.style.transform = 'scale(1)';
            }
        }
    }
}

// Error handling
function showError(message) {
    document.getElementById('errorContainer').style.display = 'block';
    document.getElementById('errorMessage').textContent = message;
}

// Model status tracking
function initializeModelStatus(models) {
    const grid = document.getElementById('modelStatusGrid');
    grid.innerHTML = '';
    
    // Use the models array passed from backend - it should have ALL selected models
    const modelList = models.length > 0 ? models : [
        'Gemini 2.0 Flash', 'Llama 3.2 3B', 'Phi-3 Medium', 'Mistral 7B', 
        'Qwen 2.5', 'Zephyr 7B Beta', 'Hermes 3', 'DeepSeek Chat'
    ];
    
    console.log(`Initializing status grid for ${modelList.length} models:`, modelList);
    
    // Make sure the grid is visible
    grid.style.display = 'grid';
    grid.style.visibility = 'visible';
    
    modelList.forEach(model => {
        const statusDiv = document.createElement('div');
        statusDiv.className = 'model-status-item';
        statusDiv.id = `model-${model.replace(/\s+/g, '-').replace(/[^\w-]/g, '')}`;  // Clean ID
        statusDiv.style.cssText = 'padding: 8px; background: var(--md-sys-color-surface-variant); border-radius: 8px; font-size: var(--md-sys-typescale-body-small); min-height: 36px; border: 1px solid var(--md-sys-color-outline-variant);';
        statusDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <span class="status-icon">‚è≥</span>
                <span class="model-name" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${model}</span>
            </div>
        `;
        grid.appendChild(statusDiv);
    });
    
    console.log('‚úÖ Model status grid initialized with', grid.children.length, 'models');
    console.log('Grid display style:', grid.style.display, 'Visibility:', grid.style.visibility);
}

function updateModelStatus(model, status) {
    console.log('üîÑ updateModelStatus called with model:', model, 'status:', status);
    
    // Add null check for model parameter
    if (!model) {
        console.info('‚ÑπÔ∏è updateModelStatus called with undefined model - attempting to parse from status message');
        
        // Try to extract model from status if available
        if (status && status.includes('Analyzing with')) {
            const match = status.match(/Analyzing with ([^.]+(?:\.[^.]*)*?)(?:\.\.\.|$)/);
            if (match) {
                model = match[1].replace(':free', ''); // Remove :free suffix
                console.log('üîç Extracted model from status:', model);
                
                // Try to find matching model element by comparing with available IDs
                const allModelDivs = document.querySelectorAll('[id^="model-"]');
                const availableIds = Array.from(allModelDivs).map(el => el.id);
                
                // Try different matching strategies
                let matchedId = null;
                for (const id of availableIds) {
                    const idPart = id.replace('model-', '').toLowerCase();
                    const modelPart = model.toLowerCase()
                        .replace(/[^a-z0-9]/g, '')
                        .replace(/it$/, '') // Remove 'it' suffix (e.g., gemma-2-9b-it ‚Üí gemma-2-9b)
                        .replace(/instruct$/, '') // Remove 'instruct' suffix
                        .replace(/free$/, ''); // Remove 'free' suffix
                    
                    const normalizedId = idPart.replace(/[^a-z0-9]/g, '');
                    
                    // Try exact match
                    if (normalizedId === modelPart) {
                        matchedId = id.replace('model-', '');
                        console.log('üéØ Found exact matching model ID:', matchedId);
                        break;
                    }
                    
                    // Try partial match (for complex model names)
                    if (normalizedId.includes(modelPart) || modelPart.includes(normalizedId)) {
                        matchedId = id.replace('model-', '');
                        console.log('üéØ Found partial matching model ID:', matchedId);
                        break;
                    }
                }
                
                if (matchedId) {
                    model = matchedId;
                } else {
                    console.log('üîç No exact match found, available IDs:', availableIds);
                }
            }
        }
        
        if (!model) return;
    }
    
    const modelName = String(model); // Ensure it's a string
    
    // Try multiple model ID matching strategies since backend sends full model names
    // like "deepseek/deepseek-chat-v3.1:free" but frontend creates IDs like "model-deepseek-deepseek-chat-v31"
    const modelVariations = [
        modelName,  // Original: "deepseek/deepseek-chat-v3.1:free"
        modelName.replace(/:\w+$/, ''),  // Remove suffix: "deepseek/deepseek-chat-v3.1"
        modelName.split('/').pop().replace(/:\w+$/, ''),  // Just model name: "deepseek-chat-v3.1"
        modelName.split(':')[0]  // Remove everything after colon: "deepseek/deepseek-chat-v3.1"
    ];
    
    let statusDiv = null;
    let matchingModelId = null;
    
    // Try each variation with the same ID normalization used in createModelStatusGrid (line 1102)
    for (const variation of modelVariations) {
        const normalizedId = variation.replace(/\s+/g, '-').replace(/[^\w-]/g, '');  // Same cleaning as line 1102
        const candidateId = `model-${normalizedId}`;
        statusDiv = document.getElementById(candidateId);
        
        console.log('üîç Trying model variation:', variation, '‚Üí', normalizedId, '‚Üí', candidateId);
        
        if (statusDiv) {
            matchingModelId = candidateId;
            console.log('‚úÖ Found matching model div with ID:', matchingModelId);
            break;
        }
    }
    
    if (statusDiv) {
        console.log('‚úÖ Found model status div for:', modelName);
        const statusIcon = statusDiv.querySelector('.status-icon');
        
        // Determine actual status from the status message
        let actualStatus = 'waiting';
        if (status && typeof status === 'string') {
            if (status.includes('completed') || status.includes('Complete') || status.includes('Success')) {
                actualStatus = 'completed';
            } else if (status.includes('Failed') || status.includes('failed') || status.includes('timeout')) {
                actualStatus = 'failed';
            } else if (status.includes('Querying') || status.includes('Processing') || status.includes('processing') || status.includes('Analyzing')) {
                actualStatus = 'processing';
            }
        }
        
        const bgColor = actualStatus === 'completed' ? 'var(--md-sys-color-primary-container)' :
                       actualStatus === 'failed' ? 'var(--md-sys-color-error-container)' :
                       actualStatus === 'processing' ? 'var(--md-sys-color-secondary-container)' :
                       'var(--md-sys-color-surface-variant)';
        
        const icon = actualStatus === 'completed' ? '‚úÖ' :
                    actualStatus === 'failed' ? '‚ùå' :
                    actualStatus === 'processing' ? 'üîÑ' : '‚è≥';
        
        statusDiv.style.background = bgColor;
        statusIcon.textContent = icon;
        console.log('üîÑ Updated model status:', modelName, '‚Üí', actualStatus, icon);
    } else {
        // Model status div not found - this is expected for models not currently selected/displayed
        // Only log this as info, not as a warning since it's normal behavior
        console.info('‚ÑπÔ∏è Model status div not found for:', modelName, '- model not currently displayed in UI');
        
        // Only show detailed debug info if we're actually trying to debug
        if (window.debugModelStatus) {
            console.log('üîç Tried IDs:', modelVariations.map(v => `model-${v.replace(/\s+/g, '-').replace(/[^\w-]/g, '')}`));
            const allModelDivs = document.querySelectorAll('[id^="model-"]');
            console.log('üìã Available model elements:', Array.from(allModelDivs).map(el => el.id));
        }
    }
}

// Add analysis summary
function addAnalysisSummary() {
    const grid = document.getElementById('modelStatusGrid');
    const allModels = grid.querySelectorAll('.model-status-item');
    let successful = 0;
    let failed = 0;
    
    allModels.forEach(div => {
        const icon = div.querySelector('.status-icon').textContent;
        if (icon === '‚úÖ') successful++;
        else if (icon === '‚ùå') failed++;
    });
    
    const summaryDiv = document.createElement('div');
    summaryDiv.style.cssText = 'grid-column: 1 / -1; margin-top: 16px; padding: 16px; background: var(--md-sys-color-surface); border-radius: 8px; border: 2px solid var(--md-sys-color-primary);';
    summaryDiv.innerHTML = `
        <h4 style="margin-bottom: 8px;">üìä Analysis Summary</h4>
        <div style="display: flex; gap: 24px;">
            <div>‚úÖ <strong>${successful}</strong> models succeeded</div>
            <div>‚ùå <strong>${failed}</strong> models failed</div>
            <div>üìà <strong>${Math.round((successful / (successful + failed)) * 100)}%</strong> success rate</div>
        </div>
    `;
    
    // Only add if not already present
    if (!grid.querySelector('.analysis-summary')) {
        summaryDiv.className = 'analysis-summary';
        grid.appendChild(summaryDiv);
    }
}

// Display results with enhanced visualization
function displayResults(results) {
    document.getElementById('resultsSection').style.display = 'block';
    
    // Display consensus report with enhanced styling
    const consensusDiv = document.getElementById('consensusReport');
    consensusDiv.innerHTML = `
        <!-- Primary Diagnoses Section -->
        <div class="card primary-card" style="margin-bottom: 24px;">
            <h3 style="color: var(--md-sys-color-on-primary-container); margin-bottom: 16px;">
                <span style="font-size: 24px; vertical-align: middle;">üéØ</span> Primary Diagnoses
            </h3>
            <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                ${(results.primary_diagnoses || []).map(d => `
                    <div style="background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); 
                                padding: 12px 20px; border-radius: 24px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-weight: 600;">${d.diagnosis}</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 0.9em;">
                            ${d.confidence}%
                        </span>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <!-- Alternative Diagnoses Section -->
        <div class="card" style="margin-bottom: 24px; background: var(--md-sys-color-secondary-container);">
            <h3 style="color: var(--md-sys-color-on-secondary-container); margin-bottom: 16px;">
                <span style="font-size: 24px; vertical-align: middle;">üîÑ</span> Alternative Diagnoses
            </h3>
            <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                ${(results.alternative_diagnoses || []).map(d => `
                    <div style="background: var(--md-sys-color-secondary); color: var(--md-sys-color-on-secondary); 
                                padding: 10px 18px; border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                        <span>${d.diagnosis}</span>
                        <span style="background: rgba(255,255,255,0.2); padding: 3px 6px; border-radius: 10px; font-size: 0.85em;">
                            ${d.confidence}%
                        </span>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <!-- Minority Opinions Section -->
        <div class="card" style="background: var(--md-sys-color-tertiary-container);">
            <h3 style="color: var(--md-sys-color-on-tertiary-container); margin-bottom: 16px;">
                <span style="font-size: 24px; vertical-align: middle;">üí°</span> Minority Opinions
            </h3>
            <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                ${(results.minority_opinions || []).map(d => `
                    <div style="background: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant); 
                                padding: 8px 16px; border-radius: 16px; display: flex; align-items: center; gap: 8px;
                                border: 1px solid var(--md-sys-color-outline-variant);">
                        <span>${d.diagnosis}</span>
                        <span style="background: var(--md-sys-color-surface); padding: 2px 6px; border-radius: 8px; font-size: 0.8em;">
                            ${d.confidence}%
                        </span>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <!-- Key Insights Section -->
        <div class="card" style="margin-top: 24px; background: linear-gradient(135deg, var(--md-sys-color-primary-container), var(--md-sys-color-secondary-container));">
            <h3 style="margin-bottom: 16px;">
                <span style="font-size: 24px; vertical-align: middle;">üìä</span> Analysis Insights
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div style="background: rgba(255,255,255,0.8); padding: 16px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 32px; font-weight: bold; color: var(--md-sys-color-primary);">
                        ${results.primary_diagnoses ? results.primary_diagnoses.length : 0}
                    </div>
                    <div style="font-size: 14px; color: var(--md-sys-color-on-surface-variant);">
                        Primary Diagnoses
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.8); padding: 16px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 32px; font-weight: bold; color: var(--md-sys-color-secondary);">
                        ${results.alternative_diagnoses ? results.alternative_diagnoses.length : 0}
                    </div>
                    <div style="font-size: 14px; color: var(--md-sys-color-on-surface-variant);">
                        Alternative Options
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.8); padding: 16px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 32px; font-weight: bold; color: var(--md-sys-color-tertiary);">
                        ${results.models_responded || (results.model_responses ? results.model_responses.length : 0)}
                    </div>
                    <div style="font-size: 14px; color: var(--md-sys-color-on-surface-variant);">
                        Models Responded
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.8); padding: 16px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 32px; font-weight: bold; color: var(--md-sys-color-error);">
                        ${results.primary_diagnoses && results.primary_diagnoses[0] ? results.primary_diagnoses[0].confidence || 0 : 0}%
                    </div>
                    <div style="font-size: 14px; color: var(--md-sys-color-on-surface-variant);">
                        Top Confidence
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add model responses tab content with real data
    const modelsDiv = document.getElementById('modelResponses');
    const modelResponses = (results.model_responses || []).map(response => {
        let diagnosis = 'Unknown';
        let confidence = 0;
        
        // Parse the response to extract diagnosis and confidence
        try {
            const responseText = response.response || '';
            const jsonMatch = responseText.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const parsedResponse = JSON.parse(jsonMatch[0]);
                if (parsedResponse.primary_diagnosis) {
                    diagnosis = parsedResponse.primary_diagnosis.name || 'Unknown';
                    confidence = Math.round((parsedResponse.primary_diagnosis.confidence || 0) * 100);
                }
            } else {
                diagnosis = 'Failed to parse response';
            }
        } catch (e) {
            diagnosis = 'Response parsing error';
            confidence = 0;
        }
        
        return {
            name: response.model_name || 'Unknown Model',
            status: response.response ? '‚úÖ' : '‚ùå',
            diagnosis: diagnosis,
            confidence: confidence,
            rawResponse: response.response || 'No response'
        };
    });
    
    modelsDiv.innerHTML = `
        <div style="display: grid; gap: 16px;">
            ${modelResponses.map(model => `
                <div class="card" style="border: 1px solid ${model.status === '‚úÖ' ? 'var(--md-sys-color-outline-variant)' : 'var(--md-sys-color-error)'};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4 style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span>${model.status}</span>
                                <span>${model.name}</span>
                            </h4>
                            ${model.status === '‚úÖ' ? `
                                <div style="margin-bottom: 8px;">
                                    <strong>Primary Diagnosis:</strong> ${model.diagnosis}
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="background: var(--md-sys-color-primary-container); 
                                               padding: 4px 12px; border-radius: 16px;">
                                        Confidence: ${model.confidence}%
                                    </span>
                                </div>
                                <details style="margin-top: 12px;">
                                    <summary style="cursor: pointer; color: var(--md-sys-color-primary);">
                                        View Full Response
                                    </summary>
                                    <div style="margin-top: 8px; padding: 12px; background: var(--md-sys-color-surface-variant); 
                                              border-radius: 8px; font-size: 0.9em; white-space: pre-wrap;">
                                        <strong>Raw Model Response:</strong>
                                        <br><br>
                                        ${model.rawResponse}
                                    </div>
                                </details>
                            ` : `
                                <div style="color: var(--md-sys-color-error);">
                                    Model failed to respond within timeout period
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    // Add raw responses tab content
    const rawDiv = document.getElementById('rawResponses');
    rawDiv.innerHTML = `
        <div class="card">
            <h3>Raw Model Outputs</h3>
            <pre style="background: var(--md-sys-color-surface-variant); padding: 16px; border-radius: 8px; overflow-x: auto;">
${JSON.stringify(results, null, 2)}
            </pre>
        </div>
    `;
}

// Load sample case
function loadSampleCase() {
    document.getElementById('caseText').value = `A 45-year-old male presents to the emergency department with sudden onset chest pain that started 2 hours ago. The pain is described as crushing, substernal, and radiates to the left arm. He has been sweating profusely and feels nauseous. 

Past Medical History:
- Hypertension (diagnosed 5 years ago, on amlodipine)
- Type 2 Diabetes Mellitus (diagnosed 3 years ago, on metformin)
- Hyperlipidemia (on atorvastatin)
- 20 pack-year smoking history, quit 2 years ago

Physical Examination:
- BP: 150/90 mmHg, HR: 95 bpm
- Diaphoretic, appears anxious
- Cardiovascular: Normal S1/S2, no murmurs
- Lungs: Clear bilaterally

Initial Tests:
- ECG: ST elevation in leads II, III, and aVF
- Troponin I: 0.8 ng/mL (elevated)`;
}

// Other functions
function downloadReport() {
    if (currentAnalysisId) {
        window.location.href = `/api/analyze/${currentAnalysisId}/download`;
    }
}

function shareAnalysis() {
    if (currentAnalysisId) {
        alert('Share link: ' + window.location.origin + '/share/' + currentAnalysisId);
    }
}

function startNewAnalysis() {
    document.getElementById('analyzeForm').reset();
    document.getElementById('resultsSection').style.display = 'none';
    currentAnalysisId = null;
}

// Global variables to store current report URLs
let currentReportUrl = null;
let currentPdfUrl = null;

function viewFullReport() {
    if (currentReportUrl) {
        window.open(currentReportUrl, '_blank');
    } else {
        alert('Report URL not available');
    }
}

function downloadPDFReport() {
    if (currentPdfUrl) {
        window.open(currentPdfUrl, '_blank');
    } else {
        alert('PDF report not available');
    }
}

function viewFullReportFromHistory(analysisId) {
    // Load the analysis from localStorage and open its full report
    const recentAnalyses = JSON.parse(localStorage.getItem('medley_recent_analyses') || '[]');
    const analysis = recentAnalyses.find(a => a.id === analysisId);
    
    if (analysis && analysis.report_url) {
        console.log('üîó Opening full report from history:', analysis.report_url);
        window.open(analysis.report_url, '_blank');
    } else if (analysis) {
        console.warn('‚ö†Ô∏è Analysis found but no report_url available:', analysis);
        // Fallback to old behavior for backward compatibility
        viewAnalysis(analysisId);
    } else {
        console.error('‚ùå Analysis not found in history:', analysisId);
        alert('Analysis not found in history');
    }
}

function saveAnalysisToHistory(analysisId, caseText, results) {
    // Get existing analyses from localStorage
    let recentAnalyses = JSON.parse(localStorage.getItem('medley_recent_analyses') || '[]');
    console.log('üìä Existing analyses before save:', recentAnalyses.length);
    
    // Check for duplicate ID and make unique if needed
    const existingIndex = recentAnalyses.findIndex(a => a.id === analysisId);
    if (existingIndex !== -1) {
        analysisId = analysisId + '_' + Date.now();
        console.log('‚ö†Ô∏è Duplicate ID detected, using unique ID:', analysisId);
    }
    
    // Extract diagnosis info from the correct path in the data structure
    let primaryDiagnosis = 'Unknown';
    let confidence = 0;
    
    // Try to extract from diagnostic_landscape (preferred)
    if (results.diagnostic_landscape && results.diagnostic_landscape.primary_diagnosis) {
        primaryDiagnosis = results.diagnostic_landscape.primary_diagnosis.name || 'Unknown';
        confidence = Math.round(results.diagnostic_landscape.primary_diagnosis.percentage || 0);
    }
    // Fallback to other possible structures
    else if (results.primary_diagnoses && results.primary_diagnoses[0]) {
        primaryDiagnosis = results.primary_diagnoses[0].diagnosis || 'Unknown';
        confidence = results.primary_diagnoses[0].confidence || 0;
    }
    // Another fallback for consensus_analysis
    else if (results.consensus_analysis && results.consensus_analysis.primary_diagnosis) {
        primaryDiagnosis = results.consensus_analysis.primary_diagnosis || 'Unknown';
        confidence = Math.round((results.consensus_analysis.primary_confidence || 0) * 100);
    }
    
    // Create new analysis entry WITH the full results
    const newAnalysis = {
        id: analysisId,
        timestamp: new Date().toISOString(),
        caseText: caseText,  // Save full case text
        casePreview: caseText.substring(0, 150) + (caseText.length > 150 ? '...' : ''),
        primaryDiagnosis: primaryDiagnosis,
        confidence: confidence,
        modelCount: document.querySelectorAll('.model-check:checked').length || 8,
        successRate: 87.5,  // From simulation
        results: results,  // SAVE THE FULL RESULTS!
        report_url: results.report_url,  // Store report URLs
        pdf_url: results.pdf_url
    };
    
    // Add to beginning of array
    recentAnalyses.unshift(newAnalysis);
    
    // Keep only last 10 analyses
    recentAnalyses = recentAnalyses.slice(0, 10);
    
    // Save back to localStorage
    localStorage.setItem('medley_recent_analyses', JSON.stringify(recentAnalyses));
    console.log('üíæ Saved analyses to localStorage, total count:', recentAnalyses.length);
    console.log('üìã Analysis IDs:', recentAnalyses.map(a => a.id));
    
    // Reload the display
    loadRecentAnalyses();
}

// Load sample case function
function loadSampleCase() {
    console.log('üìã Loading sample case...');
    const caseText = `A 28-year-old male of Mediterranean descent presents with:
- Recurrent episodes of fever lasting 1-3 days
- Severe abdominal pain during episodes
- Chest pain with breathing difficulties
- Joint pain affecting knees and ankles
- Family history: Father and paternal uncle have similar symptoms
- Episodes occur every 2-3 weeks
- Labs during attack: Elevated CRP, ESR, and WBC
- Between attacks: Completely asymptomatic

Patient reports episodes started in childhood around age 7. Recent genetic testing is pending.`;
    
    document.getElementById('caseText').value = caseText;
    console.log('‚úÖ Sample case loaded');
}

function loadRecentAnalyses() {
    const recentAnalyses = JSON.parse(localStorage.getItem('medley_recent_analyses') || '[]');
    console.log('üìñ Loading recent analyses, found:', recentAnalyses.length);
    const container = document.getElementById('recentAnalyses');
    
    if (recentAnalyses.length === 0) {
        container.innerHTML = `
            <p style="color: var(--md-sys-color-on-surface-variant);">
                No recent analyses found. Start your first analysis above!
            </p>
        `;
    } else {
        container.innerHTML = `
            <div style="display: grid; gap: 12px;">
                ${recentAnalyses.map(analysis => {
                    const date = new Date(analysis.timestamp);
                    const timeAgo = getTimeAgo(date);
                    
                    return `
                        <div class="card" style="padding: 16px; cursor: pointer; transition: all 0.2s; border: 1px solid var(--md-sys-color-outline-variant);"
                             onclick="viewFullReportFromHistory('${analysis.id}')"
                             onmouseover="this.style.background='var(--md-sys-color-primary-container)'"
                             onmouseout="this.style.background='var(--md-sys-color-surface)'">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="font-weight: 600; color: var(--md-sys-color-primary);">
                                            ${analysis.primaryDiagnosis}
                                        </span>
                                    </div>
                                    <div style="font-size: 0.9em; color: var(--md-sys-color-on-surface-variant); 
                                              margin-bottom: 4px; line-height: 1.4;">
                                        ${analysis.casePreview}
                                    </div>
                                    <div style="display: flex; gap: 16px; font-size: 0.85em; color: var(--md-sys-color-outline);">
                                        <span>üìÖ ${timeAgo}</span>
                                        <span>ü§ñ ${analysis.modelCount} models analyzed</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-text" onclick="event.stopPropagation(); downloadAnalysis('${analysis.id}')"
                                            style="padding: 8px;" title="Download Report">
                                        üì•
                                    </button>
                                    <button class="btn btn-text" onclick="event.stopPropagation(); deleteAnalysis('${analysis.id}')"
                                            style="padding: 8px; color: var(--md-sys-color-error);" title="Delete">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return 'just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
    if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
    
    return date.toLocaleDateString();
}

function viewAnalysis(analysisId) {
    // Load the analysis from localStorage and display it
    const recentAnalyses = JSON.parse(localStorage.getItem('medley_recent_analyses') || '[]');
    const analysis = recentAnalyses.find(a => a.id === analysisId);
    
    if (analysis && analysis.results) {
        // Clear any existing analysis state
        hideProgress();
        
        // Display the saved results
        displayResults(analysis.results);
        
        // Optionally, load the case text if you want to show it
        if (analysis.caseText) {
            document.getElementById('caseText').value = analysis.caseText;
        }
        
        // Scroll to results
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    } else {
        alert('Analysis results not found. They may have been cleared from browser storage.');
    }
}

function downloadAnalysis(analysisId) {
    window.location.href = `/api/analyze/${analysisId}/download`;
}

function deleteAnalysis(analysisId) {
    if (confirm('Are you sure you want to delete this analysis?')) {
        let recentAnalyses = JSON.parse(localStorage.getItem('medley_recent_analyses') || '[]');
        recentAnalyses = recentAnalyses.filter(a => a.id !== analysisId);
        localStorage.setItem('medley_recent_analyses', JSON.stringify(recentAnalyses));
        loadRecentAnalyses();
    }
}

function clearAnalysisHistory() {
    if (confirm('Are you sure you want to clear all analysis history? This cannot be undone.')) {
        localStorage.removeItem('medley_recent_analyses');
        loadRecentAnalyses();
        showNotification('‚úì Analysis history cleared', 'success');
    }
}
</script>
{% endblock %}