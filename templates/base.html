<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MEDLEY - Medical AI Ensemble System{% endblock %}</title>
    
    <!-- Material 3 Design System -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    
    <!-- Karolinska Institutet Theme -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/karolinska-theme.css') }}">
    
    <!-- Material 3 Expressive CSS (as base) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/material3.css') }}">
    
    <!-- Karolinska Theme Override -->
    <style>
        :root {
            /* Override Material 3 colors with Karolinska palette */
            --md-sys-color-primary: #4F0433;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #FEEEEB;
            --md-sys-color-on-primary-container: #4F0433;
            
            --md-sys-color-secondary: #FF876F;
            --md-sys-color-on-secondary: #2D2D2D;
            --md-sys-color-secondary-container: #EDF4F4;
            --md-sys-color-on-secondary-container: #4F0433;
            
            --md-sys-color-tertiary: #870052;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #4DB6AC;
            --md-sys-color-on-tertiary-container: #002420;
            
            --md-sys-color-error: #BA1A1A;
            --md-sys-color-error-container: #FFDAD6;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-on-error-container: #410002;
            
            --md-sys-color-background: #EDF4F4;
            --md-sys-color-on-background: #1C1B1F;
            --md-sys-color-surface: #FFFFFF;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-surface-variant: #FEEEEB;
            --md-sys-color-on-surface-variant: #4F0433;
            
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
            --md-sys-color-shadow: #000000;
            --md-sys-color-scrim: #000000;
            
            --md-sys-color-inverse-surface: #313033;
            --md-sys-color-inverse-on-surface: #F4EFF4;
            --md-sys-color-inverse-primary: #D0BCFF;
            
            /* Typography scale */
            --md-sys-typescale-display-large: 57px;
            --md-sys-typescale-display-medium: 45px;
            --md-sys-typescale-display-small: 36px;
            --md-sys-typescale-headline-large: 32px;
            --md-sys-typescale-headline-medium: 28px;
            --md-sys-typescale-headline-small: 24px;
            --md-sys-typescale-title-large: 22px;
            --md-sys-typescale-title-medium: 16px;
            --md-sys-typescale-title-small: 14px;
            --md-sys-typescale-body-large: 16px;
            --md-sys-typescale-body-medium: 14px;
            --md-sys-typescale-body-small: 12px;
            --md-sys-typescale-label-large: 14px;
            --md-sys-typescale-label-medium: 12px;
            --md-sys-typescale-label-small: 11px;
            
            /* Elevation */
            --md-sys-elevation-level0: none;
            --md-sys-elevation-level1: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-level2: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-level3: 0px 1px 3px rgba(0, 0, 0, 0.3), 0px 4px 8px 3px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-level4: 0px 2px 3px rgba(0, 0, 0, 0.3), 0px 6px 10px 4px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-level5: 0px 4px 4px rgba(0, 0, 0, 0.3), 0px 8px 12px 6px rgba(0, 0, 0, 0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            line-height: 1.6;
        }
        
        .material-symbols-rounded {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        /* Navigation Rail */
        .nav-rail {
            position: fixed;
            left: 0;
            top: 0;
            width: 80px;
            height: 100vh;
            background-color: var(--md-sys-color-surface);
            border-right: 1px solid var(--md-sys-color-outline-variant);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 0;
            z-index: 100;
        }
        
        .nav-rail-item {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .nav-rail-item:hover {
            background-color: var(--md-sys-color-primary-container);
        }
        
        .nav-rail-item.active {
            background-color: var(--md-sys-color-secondary-container);
        }
        
        .nav-rail-item .material-symbols-rounded {
            font-size: 24px;
            color: var(--md-sys-color-on-surface-variant);
        }
        
        .nav-rail-item.active .material-symbols-rounded {
            color: var(--md-sys-color-on-secondary-container);
        }
        
        /* Main Content */
        .main-content {
            margin-left: 80px;
            min-height: 100vh;
        }
        
        /* Top App Bar */
        .top-app-bar {
            height: 64px;
            background-color: var(--md-sys-color-surface);
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            display: flex;
            align-items: center;
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .top-app-bar-title {
            font-size: var(--md-sys-typescale-title-large);
            font-weight: 500;
            margin-left: 16px;
        }
        
        /* Cards */
        .card {
            background-color: var(--md-sys-color-surface);
            border-radius: 24px;
            padding: 24px;
            box-shadow: var(--md-sys-elevation-level1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card:hover {
            box-shadow: var(--md-sys-elevation-level3);
        }
        
        .card-outlined {
            background-color: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 12px;
            padding: 16px;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 24px;
            border-radius: 20px;
            border: none;
            font-weight: 500;
            font-size: var(--md-sys-typescale-label-large);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-filled {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        
        .btn-filled:hover {
            box-shadow: var(--md-sys-elevation-level2);
        }
        
        .btn-tonal {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }
        
        .btn-outlined {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
        }
        
        .btn-text {
            background-color: transparent;
            color: var(--md-sys-color-primary);
        }
        
        /* FAB */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--md-sys-elevation-level3);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .fab:hover {
            box-shadow: var(--md-sys-elevation-level4);
            transform: scale(1.05);
        }
        
        .fab.extended {
            width: auto;
            padding: 0 20px;
        }
        
        /* Chips */
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 8px;
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            font-size: var(--md-sys-typescale-label-large);
            margin: 4px;
        }
        
        .chip.selected {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }
        
        /* Progress */
        .progress-linear {
            height: 4px;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-linear-bar {
            height: 100%;
            background-color: var(--md-sys-color-primary);
            border-radius: 2px;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav-rail {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
    
    {% block styles %}{% endblock %}
</head>
<body>
    <!-- Navigation Rail -->
    <nav class="nav-rail">
        <div class="nav-rail-item {% if request.endpoint == 'index' %}active{% endif %}" data-page="home" title="Home">
            <span class="material-symbols-rounded">home</span>
        </div>
        <div class="nav-rail-item {% if request.endpoint == 'view_case' %}active{% endif %}" data-page="cases" title="Cases">
            <span class="material-symbols-rounded">folder_open</span>
        </div>
        <div class="nav-rail-item {% if request.endpoint == 'analyze' %}active{% endif %}" data-page="analyze" title="Analyze">
            <span class="material-symbols-rounded">biotech</span>
        </div>
        <div class="nav-rail-item {% if request.endpoint == 'dashboard' %}active{% endif %}" data-page="dashboard" title="Dashboard">
            <span class="material-symbols-rounded">dashboard</span>
        </div>
        <div class="nav-rail-item {% if request.endpoint == 'settings' %}active{% endif %}" data-page="settings" title="Settings">
            <span class="material-symbols-rounded">settings</span>
        </div>
    </nav>
    
    <!-- Main Content Area -->
    <div class="main-content">
        {% block content %}{% endblock %}
    </div>
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <!-- Base JavaScript with cache busting -->
    <script>
        // Navigation handling
        document.querySelectorAll('.nav-rail-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-rail-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                const page = this.dataset.page;
                if (page === 'home') {
                    window.location.href = '/';
                } else if (page === 'cases') {
                    // Navigate to home page and scroll to cases section
                    if (window.location.pathname === '/') {
                        // Already on home page, just scroll
                        document.getElementById('cases')?.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        // Navigate to home page with hash
                        window.location.href = '/#cases';
                    }
                } else if (page === 'analyze') {
                    window.location.href = '/analyze';
                } else if (page === 'dashboard') {
                    window.location.href = '/dashboard';
                } else if (page === 'settings') {
                    window.location.href = '/settings';
                }
            });
        });
        
        // Handle hash navigation on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.location.hash === '#cases') {
                // Wait a bit for the page to fully render, then scroll
                setTimeout(() => {
                    document.getElementById('cases')?.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            }
        });
        
        // Socket.IO connection with extended timeout for long analyses
        // Make socket globally available for all pages
        window.socket = io('/', {
            transports: ['websocket', 'polling'],  // Try WebSocket first, fall back to polling
            reconnection: true,    // Enable auto-reconnection
            reconnectionAttempts: 10,  // Try 10 times to reconnect
            reconnectionDelay: 1000,   // Start with 1 second delay
            reconnectionDelayMax: 5000 // Max 5 seconds between attempts
        });
        
        socket.on('connect', function() {
            console.log('✅ Connected to MEDLEY server');
        });
        
        socket.on('disconnect', function() {
            console.log('⚠️ Disconnected from server - will attempt to reconnect...');
        });
        
        socket.on('reconnect', function(attemptNumber) {
            console.log('✅ Reconnected to server after', attemptNumber, 'attempts');
        });
        
        socket.on('reconnect_attempt', function(attemptNumber) {
            console.log('🔄 Attempting to reconnect... (attempt', attemptNumber, ')');
        });
        
        socket.on('reconnect_failed', function() {
            console.log('❌ Failed to reconnect after all attempts');
        });
    </script>
    
    {% block scripts %}{% endblock %}
    
    <!-- Copyright Footer -->
    <footer style="position: fixed; bottom: 0; left: 80px; right: 0; background: var(--md-sys-color-surface); border-top: 1px solid var(--md-sys-color-outline-variant); padding: 8px 24px; text-align: center; font-size: var(--md-sys-typescale-body-small); color: var(--md-sys-color-on-surface-variant); z-index: 5;">
        © 2025 SMAILE (Stockholm Medical Artificial Intelligence and Learning Environments), Karolinska Institutet. Created by Farhad Abtahi. All rights reserved.
    </footer>
</body>
</html>